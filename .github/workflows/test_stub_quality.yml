name: test_stub_quality
on: [ pull_request, workflow_dispatch] # Not on push to avoid wasting 15 mins CPU 

env:
  # Setting an environment variable with the value of a configuration variable
  SNIPPET_SCORE: ${{ vars.SNIPPET_SCORE }}
  GH_TOKEN_VARS: ${{ secrets.GH_TOKEN_VARS }}
  # fix:  DeprecationWarning: Jupyter is migrating its paths to use standard platformdirs
  JUPYTER_PLATFORM_DIRS: "1"


jobs:
  # Test with --stable-only: current stable release (BLOCKING - will fail workflow)
  test_snippets:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      #----------------------------------------------

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6
        # Note: https://github.com/marketplace/actions/astral-sh-setup-uv#activate-environment
        # with:
        #   activate-environment: true

      - name: Install poetry # poetry is not in the default image
        run: uv tool install poetry

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11" # Replace with the Python version you're using


      - name: Install Python dependencies
        working-directory: ${{github.workspace}}
        run: |
          uv venv
          uv pip install -U -r pyproject.toml --extra stubber --extra test


      #----------------------------------------------
      # stubber clone
      # repos needed for tests
      #----------------------------------------------
      - name: stubber clone
        run: | 
          uv run stubber clone

      - name: Get stable version
        id: get_version
        run: |
          STABLE_VERSION=$(uv run python -c "from mpflash.versions import get_stable_mp_version; print(get_stable_mp_version())")
          echo "stable_version=$STABLE_VERSION" >> $GITHUB_OUTPUT
          echo "Testing stable version: $STABLE_VERSION"

    #   - name: update the stubs (not pushed) 
    #     continue-on-error: true
    #     run: |
    #       source .venv/bin/activate
    #       pwsh -file ./update-stubs.ps1

      - name: Test the snippets (stable only - blocking)
        continue-on-error: true
        run: |
          uv run pytest -m 'snippets' --stable-only --cache-clear --junitxml=./results/results.xml


      - name: Compare and update (stable - will fail on drop)
        env:
          VERSION_TYPE: stable
          TEST_VERSION: ${{ steps.get_version.outputs.stable_version }}
        run: |
          uv run python .github/workflows/compare_score.py

      - name: Upload results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snippet-results-stable-${{ github.run_id }}
          path: results/

  # Test with --preview-only: most recent preview version (NON-BLOCKING - warnings only)
  test_snippets_preview:
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6

      - name: Install poetry
        run: uv tool install poetry

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        working-directory: ${{github.workspace}}
        run: |
          uv venv
          uv pip install -U -r pyproject.toml --extra stubber --extra test

      - name: stubber clone
        run: |
          uv run stubber clone

      - name: Get preview version
        id: get_version
        run: |
          PREVIEW_VERSION=$(uv run python -c "from mpflash.versions import get_preview_mp_version; print(get_preview_mp_version())")
          echo "preview_version=$PREVIEW_VERSION" >> $GITHUB_OUTPUT
          echo "Testing preview version: $PREVIEW_VERSION"

      - name: Test the snippets (preview only - non-blocking)
        continue-on-error: true
        run: |
          uv run pytest -m 'snippets' --preview-only --cache-clear --junitxml=./results/results_preview.xml

      - name: Compare and log (preview - non-blocking)
        continue-on-error: true
        env:
          VERSION_TYPE: preview
          TEST_VERSION: ${{ steps.get_version.outputs.preview_version }}
        run: |
          uv run python .github/workflows/compare_score.py

      - name: Upload preview results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snippet-results-preview-${{ github.run_id }}
          path: results/

  # Test with --recent-majors: last 3 stable major.minor releases (NON-BLOCKING - warnings only)
  test_snippets_recent:
    runs-on: ubuntu-latest
    continue-on-error: true
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install the latest version of uv
        uses: astral-sh/setup-uv@v6

      - name: Install poetry
        run: uv tool install poetry

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        working-directory: ${{github.workspace}}
        run: |
          uv venv
          uv pip install -U -r pyproject.toml --extra stubber --extra test

      - name: stubber clone
        run: |
          uv run stubber clone

      - name: Test the snippets (recent majors - non-blocking)
        continue-on-error: true
        run: |
          uv run pytest -m 'snippets' --recent-majors --cache-clear --junitxml=./results/results_recent.xml

      - name: Compare and log (recent majors - non-blocking)
        continue-on-error: true
        env:
          VERSION_TYPE: recent_majors
        run: |
          uv run python .github/workflows/compare_score.py

      - name: Upload recent majors results artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: snippet-results-recent-${{ github.run_id }}
          path: results/

