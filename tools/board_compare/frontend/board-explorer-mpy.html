<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroPython Board Explorer & Comparison (PyScript)</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- PyScript CSS -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        /* Navigation */
        nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        nav h1 {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }
        
        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
        }
        
        /* Page Content */
        .page {
            display: none;
            padding: 30px;
        }
        
        .page.active {
            display: block;
        }
        
        /* Controls */
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        select, input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 50px 40px;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .loading p {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .spinner {
            border: 4px solid #e9ecef;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-step {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            display: inline-block;
            margin-top: 15px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        /* Detail View */
        .detail-view {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .detail-header {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        /* Tree View Styles */
        .tree-item {
            margin-bottom: 4px;
        }
        
        .tree-node {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }
        
        .tree-node:hover {
            background: #f0f0f0 !important;
        }
        
        .tree-children {
            margin-left: 24px;
            border-left: 3px solid #667eea;
            padding-left: 20px;
            margin-top: 8px;
        }
        
        .tree-children.hidden {
            display: none;
        }
        
        .fa-icon {
            margin-right: 8px;
        }
        
        /* Status indicator for PyScript */
        .status-indicator {
            padding: 10px 20px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .status-indicator.success {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        
        .status-indicator.error {
            background: #ffebee;
            border-left-color: #f44336;
        }
    </style>
    
    <!-- PyScript configuration -->
    <script type="mpy-config">
        {
            "packages": []
        }
    </script>
</head>
<body>
    <div class="container">
        <nav>
            <h1><i class="fas fa-microscope" style="margin-right: 10px;"></i> MicroPython Board Explorer (PyScript)</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" id="tab-explorer">Board Explorer</button>
                <button class="nav-tab" id="tab-compare">Compare Boards</button>
                <button class="nav-tab" id="tab-search">Search APIs</button>
            </div>
        </nav>
        
        <!-- Status Indicator -->
        <div style="padding: 20px;">
            <div id="status" class="status-indicator">
                <strong>Status:</strong> <span id="status-text">Initializing PyScript...</span>
            </div>
        </div>
        
        <!-- Board Explorer Page -->
        <div id="explorer-page" class="page active">
            <div class="controls">
                <div class="control-row">
                    <div class="control-group">
                        <label for="explorer-version">Version:</label>
                        <select id="explorer-version">
                            <option value="">All versions</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="explorer-board">Board:</label>
                        <select id="explorer-board">
                            <option value="">Select a board...</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="explorer-content" class="loading">
                <p>Select both version and board to explore modules and APIs</p>
            </div>
        </div>
        
        <!-- Compare Boards Page -->
        <div id="compare-page" class="page">
            <div class="controls">
                <div class="control-row">
                    <div class="control-group">
                        <label for="board1-version">Board 1 Version:</label>
                        <select id="board1-version">
                            <option value="">All versions</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="board1">Board 1:</label>
                        <select id="board1">
                            <option value="">Select a board...</option>
                        </select>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label for="board2-version">Board 2 Version:</label>
                        <select id="board2-version">
                            <option value="">All versions</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="board2">Board 2:</label>
                        <select id="board2">
                            <option value="">Select a board...</option>
                        </select>
                    </div>
                </div>
                <div class="control-row">
                    <button id="compare-btn">Compare Boards</button>
                </div>
            </div>
            <div id="compare-results"></div>
        </div>
        
        <!-- Search APIs Page -->
        <div id="search-page" class="page">
            <div class="controls">
                <div class="control-row">
                    <div class="control-group">
                        <label for="search-input">Search for Module, Class, or Method:</label>
                        <input type="text" id="search-input" placeholder="e.g., Neopixel, I2S, machine.Pin, etc.">
                    </div>
                </div>
                <button id="search-btn">Search</button>
            </div>
            
            <div id="search-results"></div>
        </div>
    </div>
    
    <!-- SQL.js for database -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    
    <!-- PyScript -->
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
    
    <!-- JavaScript for tree toggling -->
    <script>
        function toggleModule(moduleId, event) {
            if (event) event.stopPropagation();
            const elem = document.getElementById(moduleId);
            if (elem) {
                elem.classList.toggle('hidden');
            }
        }
        
        function toggleClass(classId, event) {
            if (event) event.stopPropagation();
            const elem = document.getElementById(classId);
            if (elem) {
                elem.classList.toggle('hidden');
            }
        }
    </script>
    
    <!-- Main Python script -->
    <script type="mpy">
        from pyscript import document, window, fetch, ffi
        import json
        import js
        
        # Create a namespace for board_utils
        class BoardUtils:
            pass
        
        board_utils = BoardUtils()
        
        # Dynamically load board_utils module
        async def load_board_utils():
            """Load board_utils.py dynamically"""
            try:
                response = await fetch("board_utils.py")
                if response.ok:
                    content = await response.text()
                    # Create a local namespace for the module
                    module_globals = {}
                    exec(content, module_globals)
                    
                    # Copy all functions to the board_utils object
                    for name, obj in module_globals.items():
                        if not name.startswith("_"):
                            setattr(board_utils, name, obj)
                    
                    return True
                else:
                    return False
            except Exception as e:
                print(f"Failed to load board_utils: {e}")
                return False
        
        # Global state
        app_state = {
            "boards": [],
            "current_board": None,
            "db": None,
            "SQL": None,
            "board_utils_loaded": False
        }
        
        def update_status(message, status_type="info"):
            """Update the status indicator."""
            status_elem = document.getElementById("status")
            status_text = document.getElementById("status-text")
            
            status_text.innerText = message
            
            # Reset classes
            status_elem.classList.remove("success", "error")
            
            # Add appropriate class
            if status_type == "success":
                status_elem.classList.add("success")
            elif status_type == "error":
                status_elem.classList.add("error")
        
        async def load_database():
            """Load SQLite database using SQL.js."""
            try:
                update_status("Loading SQL.js library...", "info")
                
                # Check if SQL is available in window
                if not hasattr(window, 'initSqlJs'):
                    update_status("Error: SQL.js library not loaded. Trying fallback...", "error")
                    return False
                
                # Initialize SQL.js
                SQL = await window.initSqlJs(ffi.to_js({
                    "locateFile": lambda file, *args: f"https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/{file}"
                }))
                app_state["SQL"] = SQL
                
                update_status("Fetching database file (6.7MB)...", "info")
                
                # Fetch database file
                response = await fetch("board_comparison.db")
                buffer = await response.arrayBuffer()
                
                update_status("Loading database into memory...", "info")
                
                # Create database instance
                db_array = js.Uint8Array.new(buffer)
                app_state["db"] = SQL.Database.new(db_array)
                
                update_status("Database loaded successfully!", "success")
                
                # Test database connection
                stmt = app_state["db"].prepare("SELECT COUNT(*) as count FROM boards")
                stmt.step()
                row = stmt.getAsObject()
                stmt.free()
                
                board_count = row["count"]
                update_status(f"Database ready! Found {board_count} boards.", "success")
                
                return True
                
            except Exception as e:
                update_status(f"Error loading database: {str(e)}", "error")
                print(f"Database error: {e}")
                return False
        
        async def load_board_list_from_db():
            """Load board list from database."""
            if not app_state["db"]:
                return False
            
            try:
                update_status("Loading board list from database...", "info")
                
                stmt = app_state["db"].prepare("""
                    SELECT DISTINCT version, port, board
                    FROM boards
                    ORDER BY version DESC, port, board
                """)
                
                boards = []
                while stmt.step():
                    row = stmt.getAsObject()
                    boards.append({
                        "version": row["version"],
                        "port": row["port"],
                        "board": row["board"]
                    })
                
                stmt.free()
                
                app_state["boards"] = boards
                update_status(f"Loaded {len(boards)} boards from database", "success")
                
                return True
                
            except Exception as e:
                update_status(f"Error loading board list: {str(e)}", "error")
                print(f"Board list error: {e}")
                return False
        
        def switch_page(page_id):
            """Switch between different pages."""
            # Hide all pages
            for page_name in ["explorer", "compare", "search"]:
                page = document.getElementById(f"{page_name}-page")
                tab = document.getElementById(f"tab-{page_name}")
                
                page.classList.remove("active")
                tab.classList.remove("active")
            
            # Show selected page
            page = document.getElementById(f"{page_id}-page")
            tab = document.getElementById(f"tab-{page_id}")
            
            page.classList.add("active")
            tab.classList.add("active")
        

        def populate_board_selects():
            """Populate all board selection dropdowns."""
            if not app_state["boards"]:
                return
            
            # Get unique versions
            versions = list(set(board.get("version", "") for board in app_state["boards"]))
            versions.sort(reverse=True)
            
            # Populate version selects
            for select_id in ["explorer-version", "board1-version", "board2-version"]:
                select = document.getElementById(select_id)
                select.innerHTML = '<option value="">All versions</option>'
                
                for version in versions:
                    option = document.createElement("option")
                    option.value = version
                    option.textContent = version
                    select.appendChild(option)
            
            # Get unique board names (formatted)
            board_names = list(set(
                board_utils.format_board_name(board.get("port", ""), board.get("board", ""))
                for board in app_state["boards"]
            ))
            board_names.sort()
            
            # Populate board selects
            for select_id in ["explorer-board", "board1", "board2"]:
                select = document.getElementById(select_id)
                select.innerHTML = '<option value="">Select a board...</option>'
                
                for board_name in board_names:
                    option = document.createElement("option")
                    option.value = board_name
                    option.textContent = board_name
                    select.appendChild(option)
        
        def format_board_name(port, board):
            """Format board display name."""
            return board_utils.format_board_name(port, board)
        
        # Set up event handlers
        def setup_event_handlers():
            """Set up event listeners for the UI."""
            # Tab navigation
            document.getElementById("tab-explorer").onclick = lambda e: switch_page("explorer")
            document.getElementById("tab-compare").onclick = lambda e: switch_page("compare")
            document.getElementById("tab-search").onclick = lambda e: switch_page("search")
            
            # Compare button
            document.getElementById("compare-btn").onclick = lambda e: compare_boards()
            
            # Search button
            document.getElementById("search-btn").onclick = lambda e: search_apis()
            
            # Board selection change handlers
            def make_board_change_handler():
                async def handler(e):
                    await load_board_details()
                return handler
            
            document.getElementById("explorer-version").onchange = make_board_change_handler()
            document.getElementById("explorer-board").onchange = make_board_change_handler()
        
        def compare_boards():
            """Compare two selected boards."""
            results = document.getElementById("compare-results")
            results.innerHTML = """
            <div class="detail-view">
                <div class="detail-header">Board Comparison</div>
                <p style="color: #666;">Comparison functionality coming soon...</p>
                <p style="color: #666; margin-top: 10px;">
                    This feature is under development.
                </p>
            </div>
            """
        
        def search_apis():
            """Search for APIs across boards."""
            results = document.getElementById("search-results")
            results.innerHTML = """
            <div class="detail-view">
                <div class="detail-header">Search Results</div>
                <p style="color: #666;">Search functionality coming soon...</p>
                <p style="color: #666; margin-top: 10px;">
                    This feature is under development.
                </p>
            </div>
            """
        
        def get_class_bases(class_id):
            """Get base classes for a class."""
            if not app_state["db"]:
                return []
            
            try:
                stmt = app_state["db"].prepare("""
                    SELECT ucb.base_name
                    FROM unique_class_bases ucb
                    WHERE ucb.class_id = ?
                    ORDER BY ucb.base_name
                """)
                stmt.bind([class_id])
                
                bases = []
                while stmt.step():
                    row = stmt.getAsObject()
                    bases.append(row["base_name"])
                
                stmt.free()
                return bases
            except Exception as e:
                print(f"Error getting base classes: {e}")
                return []
        
        def get_method_parameters(method_id):
            """Get parameters for a method/function."""
            if not app_state["db"]:
                return []
            
            try:
                stmt = app_state["db"].prepare("""
                    SELECT up.name, up.position, up.type_hint, up.default_value, 
                           up.is_optional, up.is_variadic
                    FROM unique_parameters up
                    WHERE up.method_id = ?
                    ORDER BY up.position
                """)
                stmt.bind([method_id])
                
                params = []
                while stmt.step():
                    row = stmt.getAsObject()
                    params.append({
                        "name": row["name"],
                        "position": row["position"],
                        "type_hint": row["type_hint"],
                        "default_value": row["default_value"],
                        "is_optional": row["is_optional"],
                        "is_variadic": row["is_variadic"]
                    })
                
                stmt.free()
                return params
            except Exception as e:
                print(f"Error getting parameters: {e}")
                return []
        
        def get_class_methods(module_id, class_id, board_context):
            """Get methods for a class."""
            if not app_state["db"]:
                return []
            
            try:
                stmt = app_state["db"].prepare("""
                    SELECT um.id, um.name, um.return_type, um.is_async, um.is_property, 
                           um.is_classmethod, um.is_staticmethod, um.decorators, um.docstring
                    FROM unique_methods um
                    JOIN board_method_support bms ON um.id = bms.method_id
                    JOIN boards b ON bms.board_id = b.id
                    WHERE um.module_id = ? AND um.class_id = ?
                      AND b.version = ? AND b.port = ? AND b.board = ?
                    ORDER BY um.name
                """)
                stmt.bind([module_id, class_id, board_context["version"], 
                          board_context["port"], board_context["board"]])
                
                methods = []
                while stmt.step():
                    row = stmt.getAsObject()
                    method_id = row["id"]
                    
                    # Get parameters
                    parameters = get_method_parameters(method_id)
                    
                    # Parse decorators
                    decorators_list = []
                    if row["decorators"]:
                        try:
                            decorators_list = js.JSON.parse(row["decorators"])
                        except:
                            pass
                    
                    methods.append({
                        "id": method_id,
                        "name": row["name"],
                        "return_type": row["return_type"],
                        "is_async": row["is_async"],
                        "is_property": row["is_property"],
                        "is_classmethod": row["is_classmethod"],
                        "is_staticmethod": row["is_staticmethod"],
                        "decorators_list": decorators_list,
                        "parameters": parameters,
                        "docstring": row["docstring"]
                    })
                
                stmt.free()
                return methods
            except Exception as e:
                print(f"Error getting class methods: {e}")
                return []
        
        def get_module_classes(module_id, board_context):
            """Get classes for a module."""
            if not app_state["db"]:
                return []
            
            try:
                stmt = app_state["db"].prepare("""
                    SELECT uc.id, uc.name, uc.docstring
                    FROM unique_classes uc
                    WHERE uc.module_id = ?
                    ORDER BY uc.name
                """)
                stmt.bind([module_id])
                
                classes = []
                while stmt.step():
                    row = stmt.getAsObject()
                    class_id = row["id"]
                    
                    # Get base classes
                    base_classes = get_class_bases(class_id)
                    
                    # Get methods
                    methods = get_class_methods(module_id, class_id, board_context)
                    
                    classes.append({
                        "id": class_id,
                        "name": row["name"],
                        "docstring": row["docstring"],
                        "base_classes": base_classes,
                        "methods": methods
                    })
                
                stmt.free()
                return classes
            except Exception as e:
                print(f"Error getting module classes: {e}")
                return []
        
        def get_module_functions(module_id, board_context):
            """Get module-level functions."""
            if not app_state["db"]:
                return []
            
            try:
                stmt = app_state["db"].prepare("""
                    SELECT um.id, um.name, um.return_type, um.is_async, um.decorators, um.docstring
                    FROM unique_methods um
                    JOIN board_method_support bms ON um.id = bms.method_id
                    JOIN boards b ON bms.board_id = b.id
                    WHERE um.module_id = ? AND um.class_id IS NULL
                      AND b.version = ? AND b.port = ? AND b.board = ?
                    ORDER BY um.name
                """)
                stmt.bind([module_id, board_context["version"], 
                          board_context["port"], board_context["board"]])
                
                functions = []
                while stmt.step():
                    row = stmt.getAsObject()
                    func_id = row["id"]
                    
                    # Get parameters
                    parameters = get_method_parameters(func_id)
                    
                    # Parse decorators
                    decorators_list = []
                    if row["decorators"]:
                        try:
                            decorators_list = js.JSON.parse(row["decorators"])
                        except:
                            pass
                    
                    functions.append({
                        "id": func_id,
                        "name": row["name"],
                        "return_type": row["return_type"],
                        "is_async": row["is_async"],
                        "decorators_list": decorators_list,
                        "parameters": parameters,
                        "docstring": row["docstring"]
                    })
                
                stmt.free()
                return functions
            except Exception as e:
                print(f"Error getting module functions: {e}")
                return []
        
        def get_module_constants(module_id):
            """Get module constants."""
            if not app_state["db"]:
                return []
            
            try:
                stmt = app_state["db"].prepare("""
                    SELECT umc.name, umc.value, umc.type
                    FROM unique_module_constants umc
                    WHERE umc.module_id = ?
                    ORDER BY umc.name
                """)
                stmt.bind([module_id])
                
                constants = []
                while stmt.step():
                    row = stmt.getAsObject()
                    constants.append({
                        "name": row["name"],
                        "value": row["value"],
                        "type": row["type"]
                    })
                
                stmt.free()
                return constants
            except Exception as e:
                print(f"Error getting constants: {e}")
                return []
        
        def render_module_tree(module):
            """Render an expandable module tree."""
            classes = module.get("classes", [])
            functions = module.get("functions", [])
            constants = module.get("constants", [])
            
            class_count = len(classes)
            func_count = len(functions)
            const_count = len(constants)
            
            # Format summary
            summary = board_utils.format_module_summary(class_count, func_count, const_count, module["name"])
            
            module_id = f"module-{module['name']}"
            
            html = f'''
            <div class="tree-item" style="margin-bottom: 6px;">
                <div class="tree-node" onclick="toggleModule('{module_id}', event)" 
                     style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea; display: flex; align-items: center;">
                    <i class="fas fa-cube fa-icon" style="color: #667eea;"></i>
                    <strong style="font-size: 1.1em; color: #2c3e50;">{module["name"]}</strong>
                    <span style="margin-left: auto; color: #6c757d; font-size: 0.9em; background: #e9ecef; padding: 4px 8px; border-radius: 12px;">
                        {summary}
                    </span>
                </div>
            '''
            
            # Add children if module has content
            if class_count > 0 or func_count > 0 or const_count > 0:
                html += f'<div id="{module_id}" class="tree-children hidden">'
                
                # Render classes
                for cls in classes:
                    html += render_class_tree(cls, module["name"])
                
                # Render module-level functions
                for func in functions:
                    sig = format_function_signature(func)
                    decorators_html = ""
                    if func.get("decorators_list"):
                        for dec in func["decorators_list"]:
                            decorators_html += f'<span style="color: #888; font-size: 0.85em;">@{dec}</span> '
                    
                    html += f'''
                    <div class="tree-item">
                        <div class="tree-node" style="padding: 8px; background: #fff; border-radius: 6px; margin-bottom: 4px;">
                            <i class="fas fa-bolt fa-icon" style="color: #f39c12;"></i>
                            {decorators_html}
                            <code style="font-family: 'Courier New', monospace; font-size: 0.9em;">{sig}</code>
                        </div>
                    </div>
                    '''
                
                # Render constants
                for const in constants:
                    value_str = f" = {const['value']}" if const.get("value") else ""
                    html += f'''
                    <div class="tree-item">
                        <div class="tree-node" style="padding: 8px; background: #fff; border-radius: 6px; margin-bottom: 4px;">
                            <i class="fas fa-circle fa-icon" style="color: #95a5a6; font-size: 0.6em;"></i>
                            <code style="font-family: 'Courier New', monospace; font-size: 0.9em;">{const["name"]}{value_str}</code>
                        </div>
                    </div>
                    '''
                
                html += '</div>'
            
            html += '</div>'
            return html
        
        def render_class_tree(cls, module_name):
            """Render an expandable class tree."""
            methods = cls.get("methods", [])
            base_classes = cls.get("base_classes", [])
            
            base_str = ""
            if base_classes:
                base_str = f" <span style='color: #888; font-weight: normal;'>({', '.join(base_classes)})</span>"
            
            class_id = f"class-{module_name}-{cls['name']}"
            
            html = f'''
            <div class="tree-item">
                <div class="tree-node" onclick="toggleClass('{class_id}', event)"
                     style="padding: 10px; background: #fff; border-radius: 6px; margin-bottom: 4px; border-left: 4px solid #e3f2fd; display: flex; align-items: center;">
                    <i class="fas fa-object-group fa-icon" style="color: #3498db;"></i>
                    <span style="font-weight: 600;">class {cls["name"]}{base_str}</span>
                    <span style="margin-left: auto; color: #6c757d; font-size: 0.85em;">{len(methods)} methods</span>
                </div>
            '''
            
            # Add methods if class has any
            if len(methods) > 0:
                html += f'<div id="{class_id}" class="tree-children hidden">'
                
                for method in methods:
                    sig = format_function_signature(method)
                    
                    # Build decorator display
                    decorators_html = ""
                    if method.get("decorators_list"):
                        for dec in method["decorators_list"]:
                            decorators_html += f'<span style="color: #888; font-size: 0.85em;">@{dec}</span> '
                    elif method.get("is_property"):
                        decorators_html = '<span style="color: #888; font-size: 0.85em;">@property</span> '
                    elif method.get("is_classmethod"):
                        decorators_html = '<span style="color: #888; font-size: 0.85em;">@classmethod</span> '
                    elif method.get("is_staticmethod"):
                        decorators_html = '<span style="color: #888; font-size: 0.85em;">@staticmethod</span> '
                    
                    html += f'''
                    <div class="tree-item">
                        <div class="tree-node" style="padding: 8px; background: #fafafa; border-radius: 6px; margin-bottom: 2px;">
                            <i class="fas fa-bolt fa-icon" style="color: #9b59b6; font-size: 0.8em;"></i>
                            {decorators_html}
                            <code style="font-family: 'Courier New', monospace; font-size: 0.85em;">{sig}</code>
                        </div>
                    </div>
                    '''
                
                html += '</div>'
            
            html += '</div>'
            return html
        
        def format_function_signature(func):
            """Format a function/method signature with parameters."""
            # Build async prefix
            async_prefix = "async " if func.get("is_async") else ""
            
            # Build parameter list
            params = []
            for param in func.get("parameters", []):
                param_str = param["name"]
                
                # Add type hint
                if param.get("type_hint") and param["type_hint"] not in ("None", ""):
                    param_str += f": {param['type_hint']}"
                
                # Add default value
                if param.get("default_value") and param["default_value"] not in ("None", ""):
                    param_str += f" = {param['default_value']}"
                elif param.get("is_optional"):
                    param_str += " = None"
                
                # Handle variadic
                if param.get("is_variadic"):
                    if param["name"] == "kwargs":
                        param_str = "**" + param_str
                    else:
                        param_str = "*" + param_str
                
                params.append(param_str)
            
            signature = f"{async_prefix}{func['name']}({', '.join(params)})"
            
            # Add return type
            if func.get("return_type") and func["return_type"] not in ("None", "", "Any"):
                signature += f" -> {func['return_type']}"
            
            return signature
        
        async def load_board_details():
            """Load board details when a board is selected."""
            version_select = document.getElementById("explorer-version")
            board_select = document.getElementById("explorer-board")
            
            selected_version = version_select.value
            selected_board_name = board_select.value
            
            content = document.getElementById("explorer-content")
            
            if not selected_version or not selected_board_name:
                content.innerHTML = '<div class="loading"><p>Select both version and board to explore modules and APIs</p></div>'
                return
            
            # Show loading
            content.innerHTML = '''
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading board details...</p>
                <div class="progress-step">Fetching modules...</div>
            </div>
            '''
            
            if not app_state["db"]:
                # Database is required
                content.innerHTML = f'''
                <div class="detail-view">
                    <div class="detail-header">{selected_board_name} ({selected_version})</div>
                    <p style="color: #dc3545; margin: 15px 0;">
                        <strong>Error:</strong> Database not loaded.
                    </p>
                    <p style="color: #666;">
                        Please refresh the page to retry loading the database.
                    </p>
                </div>
                '''
                return
            
            try:
                # Find the actual port/board from the board list
                board_info = board_utils.find_board_in_list(
                    app_state["boards"], 
                    selected_version, 
                    selected_board_name
                )
                
                if not board_info:
                    content.innerHTML = f'''
                    <div class="detail-view">
                        <h3 style="color: #dc3545;">Board Not Found</h3>
                        <p style="color: #666;">Could not find board: {selected_board_name} ({selected_version})</p>
                    </div>
                    '''
                    return
                
                port, board = board_info
                
                # Store board context for queries
                board_context = {"version": selected_version, "port": port, "board": board}
                
                # Query database for modules
                stmt = app_state["db"].prepare("""
                    SELECT um.id, um.name, um.docstring 
                    FROM unique_modules um
                    JOIN board_module_support bms ON um.id = bms.module_id
                    JOIN boards b ON bms.board_id = b.id
                    WHERE b.version = ? AND b.port = ? AND b.board = ?
                    ORDER BY um.name
                """)
                
                stmt.bind([selected_version, port, board])
                
                modules = []
                while stmt.step():
                    row = stmt.getAsObject()
                    module_id = row["id"]
                    
                    # Get classes with full details
                    classes = get_module_classes(module_id, board_context)
                    
                    # Get functions with full details
                    functions = get_module_functions(module_id, board_context)
                    
                    # Get constants
                    constants = get_module_constants(module_id)
                    
                    modules.append({
                        "id": module_id,
                        "name": row["name"],
                        "docstring": row["docstring"],
                        "classes": classes,
                        "functions": functions,
                        "constants": constants
                    })
                
                stmt.free()
                
                # Build expandable module tree
                html = f'''
                <div class="detail-view">
                    <div class="detail-header">{selected_board_name} ({selected_version})</div>
                    <div style="margin: 20px 0;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">
                            <i class="fas fa-cube"></i> Modules ({len(modules)})
                        </h3>
                        <div class="module-tree" style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                '''
                
                # Render expandable module tree
                for module in modules:
                    html += render_module_tree(module)
                
                html += '''
                        </div>
                    </div>
                </div>
                '''
                
                content.innerHTML = html
                
            except Exception as e:
                content.innerHTML = f'''
                <div class="detail-view">
                    <h3 style="color: #dc3545;">⚠️ Error Loading Board</h3>
                    <p style="color: #666; margin: 15px 0;">{str(e)}</p>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.85em;">{type(e).__name__}: {str(e)}</pre>
                </div>
                '''
                print(f"Error loading board details: {e}")
                import sys
                sys.print_exception(e)
        
        # Main initialization
        async def main():
            """Main entry point for the application."""
            update_status("Loading board utilities...", "info")
            
            # Load board_utils module dynamically
            utils_loaded = await load_board_utils()
            if not utils_loaded:
                update_status("Error: Failed to load board utilities. Some features may not work.", "error")
            else:
                app_state["board_utils_loaded"] = True
            
            update_status("PyScript loaded successfully", "success")
            
            # Set up event handlers
            setup_event_handlers()
            
            # Load database
            db_loaded = await load_database()
            
            if db_loaded:
                # Load board list from database
                await load_board_list_from_db()
                populate_board_selects()
                update_status("Application ready! Using database.", "success")
            else:
                # Database is required
                update_status("Failed to load database. Cannot continue.", "error")
        
        # Start the application
        import asyncio
        asyncio.create_task(main())
    </script>
</body>
</html>
