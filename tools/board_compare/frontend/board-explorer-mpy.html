<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroPython Board Explorer & Comparison (PyScript)</title>
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <!-- PyScript CSS -->
    <link rel="stylesheet" href="https://pyscript.net/releases/2025.8.1/core.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }
        
        /* Navigation */
        nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        nav h1 {
            font-size: 1.5em;
            font-weight: 600;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }
        
        .nav-tab:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
        }
        
        /* Page Content */
        .page {
            display: none;
            padding: 30px;
        }
        
        .page.active {
            display: block;
        }
        
        /* Controls */
        .controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .control-row {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: end;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }
        
        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        select, input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 50px 40px;
            color: #666;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .loading p {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }
        
        .spinner {
            border: 4px solid #e9ecef;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .progress-step {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            display: inline-block;
            margin-top: 15px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; }
            50% { opacity: 1; }
            100% { opacity: 0.8; }
        }
        
        /* Detail View */
        .detail-view {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .detail-header {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        
        /* Status indicator for PyScript */
        .status-indicator {
            padding: 10px 20px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        
        .status-indicator.success {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }
        
        .status-indicator.error {
            background: #ffebee;
            border-left-color: #f44336;
        }
    </style>
    
    <!-- PyScript configuration -->
    <script type="mpy-config">
        {
            "packages": [],
            "fetch": [
                {"files": ["board_comparison.json"]},
                {"files": ["board_utils.py"]}
            ],
            "js_modules": {
                "main": {
                    "https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js": "SQL"
                }
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <nav>
            <h1><i class="fas fa-microscope" style="margin-right: 10px;"></i> MicroPython Board Explorer (PyScript)</h1>
            <div class="nav-tabs">
                <button class="nav-tab active" id="tab-explorer">Board Explorer</button>
                <button class="nav-tab" id="tab-compare">Compare Boards</button>
                <button class="nav-tab" id="tab-search">Search APIs</button>
            </div>
        </nav>
        
        <!-- Status Indicator -->
        <div style="padding: 20px;">
            <div id="status" class="status-indicator">
                <strong>Status:</strong> <span id="status-text">Initializing PyScript...</span>
            </div>
        </div>
        
        <!-- Board Explorer Page -->
        <div id="explorer-page" class="page active">
            <div class="controls">
                <div class="control-row">
                    <div class="control-group">
                        <label for="explorer-version">Version:</label>
                        <select id="explorer-version">
                            <option value="">All versions</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="explorer-board">Board:</label>
                        <select id="explorer-board">
                            <option value="">Select a board...</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div id="explorer-content" class="loading">
                <p>Select both version and board to explore modules and APIs</p>
            </div>
        </div>
        
        <!-- Compare Boards Page -->
        <div id="compare-page" class="page">
            <div class="controls">
                <div class="control-row">
                    <div class="control-group">
                        <label for="board1-version">Board 1 Version:</label>
                        <select id="board1-version">
                            <option value="">All versions</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="board1">Board 1:</label>
                        <select id="board1">
                            <option value="">Select a board...</option>
                        </select>
                    </div>
                </div>
                <div class="control-row">
                    <div class="control-group">
                        <label for="board2-version">Board 2 Version:</label>
                        <select id="board2-version">
                            <option value="">All versions</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="board2">Board 2:</label>
                        <select id="board2">
                            <option value="">Select a board...</option>
                        </select>
                    </div>
                </div>
                <div class="control-row">
                    <button id="compare-btn">Compare Boards</button>
                </div>
            </div>
            <div id="compare-results"></div>
        </div>
        
        <!-- Search APIs Page -->
        <div id="search-page" class="page">
            <div class="controls">
                <div class="control-row">
                    <div class="control-group">
                        <label for="search-input">Search for Module, Class, or Method:</label>
                        <input type="text" id="search-input" placeholder="e.g., Neopixel, I2S, machine.Pin, etc.">
                    </div>
                </div>
                <button id="search-btn">Search</button>
            </div>
            
            <div id="search-results"></div>
        </div>
    </div>
    
    <!-- PyScript -->
    <script type="module" src="https://pyscript.net/releases/2025.8.1/core.js"></script>
    
    <!-- JavaScript for tree toggling -->
    <script>
        function toggleModule(moduleId) {
            const elem = document.getElementById(moduleId);
            if (elem) {
                elem.style.display = elem.style.display === 'none' ? 'block' : 'none';
            }
        }
    </script>
    
    <!-- Main Python script -->
    <script type="mpy">
        from pyscript import document, window, fetch, ffi
        import json
        import js
        import board_utils
        
        # Global state
        app_state = {
            "boards": [],
            "current_board": None,
            "db": None,
            "SQL": None
        }
        
        def update_status(message, status_type="info"):
            """Update the status indicator."""
            status_elem = document.getElementById("status")
            status_text = document.getElementById("status-text")
            
            status_text.innerText = message
            
            # Reset classes
            status_elem.classList.remove("success", "error")
            
            # Add appropriate class
            if status_type == "success":
                status_elem.classList.add("success")
            elif status_type == "error":
                status_elem.classList.add("error")
        
        async def load_database():
            """Load SQLite database using SQL.js."""
            try:
                update_status("Loading SQL.js library...", "info")
                
                # Initialize SQL.js
                SQL = await js.initSqlJs(ffi.to_js({
                    "locateFile": lambda file: f"https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/{file}"
                }))
                app_state["SQL"] = SQL
                
                update_status("Fetching database file (6.7MB)...", "info")
                
                # Fetch database file
                response = await fetch("board_comparison.db")
                buffer = await response.arrayBuffer()
                
                update_status("Loading database into memory...", "info")
                
                # Create database instance
                db_array = js.Uint8Array.new(buffer)
                app_state["db"] = SQL.Database.new(db_array)
                
                update_status("Database loaded successfully!", "success")
                
                # Test database connection
                stmt = app_state["db"].prepare("SELECT COUNT(*) as count FROM boards")
                stmt.step()
                row = stmt.getAsObject()
                stmt.free()
                
                board_count = row["count"]
                update_status(f"Database ready! Found {board_count} boards.", "success")
                
                return True
                
            except Exception as e:
                update_status(f"Error loading database: {str(e)}", "error")
                print(f"Database error: {e}")
                return False
        
        async def load_board_list_from_db():
            """Load board list from database."""
            if not app_state["db"]:
                return False
            
            try:
                update_status("Loading board list from database...", "info")
                
                stmt = app_state["db"].prepare("""
                    SELECT DISTINCT version, port, board
                    FROM boards
                    ORDER BY version DESC, port, board
                """)
                
                boards = []
                while stmt.step():
                    row = stmt.getAsObject()
                    boards.append({
                        "version": row["version"],
                        "port": row["port"],
                        "board": row["board"]
                    })
                
                stmt.free()
                
                app_state["boards"] = boards
                update_status(f"Loaded {len(boards)} boards from database", "success")
                
                return True
                
            except Exception as e:
                update_status(f"Error loading board list: {str(e)}", "error")
                print(f"Board list error: {e}")
                return False
        
        def switch_page(page_id):
            """Switch between different pages."""
            # Hide all pages
            for page_name in ["explorer", "compare", "search"]:
                page = document.getElementById(f"{page_name}-page")
                tab = document.getElementById(f"tab-{page_name}")
                
                page.classList.remove("active")
                tab.classList.remove("active")
            
            # Show selected page
            page = document.getElementById(f"{page_id}-page")
            tab = document.getElementById(f"tab-{page_id}")
            
            page.classList.add("active")
            tab.classList.add("active")
        
        async def load_json_data():
            """Load board comparison data from JSON file."""
            try:
                update_status("Loading board data from JSON...", "info")
                
                response = await fetch("board_comparison.json")
                data = await response.json()
                
                app_state["boards"] = data.get("boards", [])
                
                update_status(f"Loaded {len(app_state['boards'])} boards from JSON", "success")
                
                # Populate board dropdowns
                populate_board_selects()
                
            except Exception as e:
                update_status(f"Error loading JSON data: {str(e)}", "error")
                print(f"Error: {e}")
        
        def populate_board_selects():
            """Populate all board selection dropdowns."""
            if not app_state["boards"]:
                return
            
            # Get unique versions
            versions = list(set(board.get("version", "") for board in app_state["boards"]))
            versions.sort(reverse=True)
            
            # Populate version selects
            for select_id in ["explorer-version", "board1-version", "board2-version"]:
                select = document.getElementById(select_id)
                select.innerHTML = '<option value="">All versions</option>'
                
                for version in versions:
                    option = document.createElement("option")
                    option.value = version
                    option.textContent = version
                    select.appendChild(option)
            
            # Get unique board names (formatted)
            board_names = list(set(
                board_utils.format_board_name(board.get("port", ""), board.get("board", ""))
                for board in app_state["boards"]
            ))
            board_names.sort()
            
            # Populate board selects
            for select_id in ["explorer-board", "board1", "board2"]:
                select = document.getElementById(select_id)
                select.innerHTML = '<option value="">Select a board...</option>'
                
                for board_name in board_names:
                    option = document.createElement("option")
                    option.value = board_name
                    option.textContent = board_name
                    select.appendChild(option)
        
        def format_board_name(port, board):
            """Format board display name."""
            return board_utils.format_board_name(port, board)
        
        # Set up event handlers
        def setup_event_handlers():
            """Set up event listeners for the UI."""
            # Tab navigation
            document.getElementById("tab-explorer").onclick = lambda e: switch_page("explorer")
            document.getElementById("tab-compare").onclick = lambda e: switch_page("compare")
            document.getElementById("tab-search").onclick = lambda e: switch_page("search")
            
            # Compare button
            document.getElementById("compare-btn").onclick = lambda e: compare_boards()
            
            # Search button
            document.getElementById("search-btn").onclick = lambda e: search_apis()
            
            # Board selection change handlers
            def make_board_change_handler():
                async def handler(e):
                    await load_board_details()
                return handler
            
            document.getElementById("explorer-version").onchange = make_board_change_handler()
            document.getElementById("explorer-board").onchange = make_board_change_handler()
        
        def compare_boards():
            """Compare two selected boards."""
            results = document.getElementById("compare-results")
            results.innerHTML = """
            <div class="detail-view">
                <div class="detail-header">Board Comparison</div>
                <p style="color: #666;">Comparison functionality coming soon...</p>
                <p style="color: #666; margin-top: 10px;">
                    Currently using simplified JSON data. Full comparison requires database support.
                </p>
            </div>
            """
        
        def search_apis():
            """Search for APIs across boards."""
            results = document.getElementById("search-results")
            results.innerHTML = """
            <div class="detail-view">
                <div class="detail-header">Search Results</div>
                <p style="color: #666;">Search functionality coming soon...</p>
                <p style="color: #666; margin-top: 10px;">
                    Currently using simplified JSON data. Full search requires database support.
                </p>
            </div>
            """
        
        async def load_board_details():
            """Load board details when a board is selected."""
            version_select = document.getElementById("explorer-version")
            board_select = document.getElementById("explorer-board")
            
            selected_version = version_select.value
            selected_board_name = board_select.value
            
            content = document.getElementById("explorer-content")
            
            if not selected_version or not selected_board_name:
                content.innerHTML = '<div class="loading"><p>Select both version and board to explore modules and APIs</p></div>'
                return
            
            # Show loading
            content.innerHTML = '''
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading board details...</p>
                <div class="progress-step">Fetching modules...</div>
            </div>
            '''
            
            if not app_state["db"]:
                # Fallback to JSON - show module names only
                content.innerHTML = f'''
                <div class="detail-view">
                    <div class="detail-header">{selected_board_name} ({selected_version})</div>
                    <p style="color: #666; margin: 15px 0;">
                        Database not loaded. Showing simplified view with module names only.
                    </p>
                    <p style="color: #666;">
                        Full API details (classes, methods, parameters) require database support.
                    </p>
                </div>
                '''
                return
            
            try:
                # Find the actual port/board from the board list
                board_info = board_utils.find_board_in_list(
                    app_state["boards"], 
                    selected_version, 
                    selected_board_name
                )
                
                if not board_info:
                    content.innerHTML = f'''
                    <div class="detail-view">
                        <h3 style="color: #dc3545;">Board Not Found</h3>
                        <p style="color: #666;">Could not find board: {selected_board_name} ({selected_version})</p>
                    </div>
                    '''
                    return
                
                port, board = board_info
                
                # Query database for modules with basic counts
                stmt = app_state["db"].prepare("""
                    SELECT um.id, um.name, um.docstring 
                    FROM unique_modules um
                    JOIN board_module_support bms ON um.id = bms.module_id
                    JOIN boards b ON bms.board_id = b.id
                    WHERE b.version = ? AND b.port = ? AND b.board = ?
                    ORDER BY um.name
                """)
                
                stmt.bind([selected_version, port, board])
                
                modules = []
                while stmt.step():
                    row = stmt.getAsObject()
                    
                    # Get class count
                    class_stmt = app_state["db"].prepare("""
                        SELECT COUNT(*) as count FROM unique_classes 
                        WHERE module_id = ?
                    """)
                    class_stmt.bind([row["id"]])
                    class_stmt.step()
                    class_count = class_stmt.getAsObject()["count"]
                    class_stmt.free()
                    
                    # Get function count (module-level only, no class_id)
                    func_stmt = app_state["db"].prepare("""
                        SELECT COUNT(*) as count FROM unique_methods 
                        WHERE module_id = ? AND class_id IS NULL
                    """)
                    func_stmt.bind([row["id"]])
                    func_stmt.step()
                    func_count = func_stmt.getAsObject()["count"]
                    func_stmt.free()
                    
                    # Get constant count
                    const_stmt = app_state["db"].prepare("""
                        SELECT COUNT(*) as count FROM unique_module_constants 
                        WHERE module_id = ?
                    """)
                    const_stmt.bind([row["id"]])
                    const_stmt.step()
                    const_count = const_stmt.getAsObject()["count"]
                    const_stmt.free()
                    
                    modules.append({
                        "id": row["id"],
                        "name": row["name"],
                        "docstring": row["docstring"],
                        "classes": [],  # Would need to query for full data
                        "functions": [],
                        "constants": [],
                        "class_count": class_count,
                        "function_count": func_count,
                        "constant_count": const_count
                    })
                
                stmt.free()
                
                # Build HTML using simplified tree (just module names and counts for now)
                html = f'''
                <div class="detail-view">
                    <div class="detail-header">{selected_board_name} ({selected_version})</div>
                    <div style="margin: 20px 0;">
                        <h3 style="color: #667eea; margin-bottom: 15px;">
                            <i class="fas fa-cube"></i> Modules ({len(modules)})
                        </h3>
                        <div class="module-tree" style="background: white; border: 2px solid #e9ecef; border-radius: 8px; padding: 20px;">
                '''
                
                # Use simplified module display
                for module in modules:
                    summary = board_utils.format_module_summary(
                        module["class_count"],
                        module["function_count"],
                        module["constant_count"],
                        module["name"]
                    )
                    
                    html += f'''
                    <div class="tree-item" style="margin-bottom: 6px;">
                        <div class="tree-node" style="padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea; display: flex; align-items: center;">
                            <i class="fas fa-cube" style="margin-right: 8px; color: #667eea;"></i>
                            <strong style="font-size: 1.1em; color: #2c3e50;">{module["name"]}</strong>
                            <span style="margin-left: auto; color: #6c757d; font-size: 0.9em; background: #e9ecef; padding: 4px 8px; border-radius: 12px;">
                                {summary}
                            </span>
                        </div>
                    </div>
                    '''
                
                html += '''
                        </div>
                    </div>
                </div>
                '''
                
                content.innerHTML = html
                
            except Exception as e:
                content.innerHTML = f'''
                <div class="detail-view">
                    <h3 style="color: #dc3545;">⚠️ Error Loading Board</h3>
                    <p style="color: #666; margin: 15px 0;">{str(e)}</p>
                    <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 0.85em;">{type(e).__name__}: {str(e)}</pre>
                </div>
                '''
                print(f"Error loading board details: {e}")
                import sys
                sys.print_exception(e)
        
        # Main initialization
        async def main():
            """Main entry point for the application."""
            update_status("PyScript loaded successfully", "success")
            
            # Set up event handlers
            setup_event_handlers()
            
            # Try to load database first
            db_loaded = await load_database()
            
            if db_loaded:
                # Load board list from database
                await load_board_list_from_db()
                populate_board_selects()
                update_status("Application ready! Using database.", "success")
            else:
                # Fallback to JSON data
                update_status("Falling back to JSON data...", "info")
                await load_json_data()
                update_status("Application ready! Using simplified JSON data.", "success")
        
        # Start the application
        import asyncio
        asyncio.create_task(main())
    </script>
</body>
</html>
